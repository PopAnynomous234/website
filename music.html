<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="st.css">
    <title>Codelistener Music Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mint: #26ff9a;
            --bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 140px;
            overflow-x: hidden;
        }

        /* --- Header & Sidebar --- */
        header {
            padding: 20px 4%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            position: fixed;
            width: 100%;
            z-index: 100;
            box-sizing: border-box;
        }

        .search-box {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            outline: none;
            width: 250px;
            transition: 0.3s;
        }

        .search-box:focus {
            border-color: var(--mint);
            background: rgba(0,0,0,0.7);
            width: 350px;
        }

        /* --- Hero --- */
        .hero {
            height: 55vh;
            background: linear-gradient(to top, var(--bg), transparent), 
                        linear-gradient(to right, var(--bg), rgba(0,0,0,0.2)),
                        url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRdVD7HYYAAVqf2fKLOUgPHl7I_--dyl1maLA&s');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 4% 0 100px;
        }

        .hero h1 { font-size: 60px; margin: 0; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); }

        /* --- Row Layout --- */
        .row { margin: 30px 0 30px 100px; padding-left: 4%; }
        .row-title { font-size: 22px; margin-bottom: 15px; color: #fff; font-weight: 700; }
        .track-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scrollbar-width: none; }
        
        .track-card {
            flex: 0 0 220px; aspect-ratio: 1/1; background: var(--card-bg);
            border-radius: 8px; overflow: hidden; position: relative; cursor: pointer;
            transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .track-card:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--mint); }
        .track-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.95)); padding: 20px 12px; }
        .track-title { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-artist { font-size: 12px; color: var(--mint); margin-top: 4px; }

        /* --- Player Bar --- */
        .player-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(38, 255, 154, 0.3);
            padding: 15px 4% 30px 4%; display: flex; align-items: center; justify-content: space-between; z-index: 1000;
        }

        .now-playing-info { display: flex; align-items: center; gap: 15px; width: 25%; }
        #current-art { width: 60px; height: 60px; border-radius: 4px; border: 2px solid var(--mint); object-fit: cover; }
        
        #fav-btn { font-size: 22px; cursor: pointer; color: #444; transition: 0.3s; }
        #fav-btn.active { color: var(--mint); transform: scale(1.2); }

        .player-center { width: 45%; display: flex; flex-direction: column; align-items: center; }
        .controls { display: flex; gap: 20px; margin-bottom: 10px; align-items: center; }
        .control-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; transition: 0.2s; }
        .control-btn:hover { color: var(--mint); }

        .progress-wrapper { position: relative; width: 100%; height: 20px; }
        .squiggly-svg { position: absolute; width: 100%; height: 100%; fill: none; stroke: var(--mint); stroke-width: 3; stroke-linecap: round; pointer-events: none; }
        #seek-slider { position: absolute; width: 100%; top: 0; left: 0; cursor: pointer; opacity: 0; z-index: 5; }

        @keyframes wiggle {
            0%, 100% { d: path("M0,10 Q25,15 50,10 T100,10 T150,15 T200,10 T250,5 T300,10 T350,15 T400,10 T450,5 T500,10 T550,15 T600,10 T650,5 T700,10 T750,15 T800,10 T850,5 T900,10 T950,15 T1000,10"); }
            50% { d: path("M0,10 Q25,5 50,10 T100,10 T150,5 T200,10 T250,15 T300,10 T350,5 T400,10 T450,15 T500,10 T550,5 T600,10 T650,15 T700,10 T750,5 T800,10 T850,15 T900,10 T950,5 T1000,10"); }
        }
        .animate-wiggle { animation: wiggle 1.2s infinite ease-in-out; }
    </style>
</head>
<body>

    <canvas id="pipCanvas" width="500" height="500" style="display:none;"></canvas>
    <video id="pipVideo" muted autoplay playsinline style="display:none;"></video>

 <div class="sidebar">
    <img src="https://cdn.jsdelivr.net/gh/PopAnynomous234/assets/logo.png" width="70" height="70" alt="logo">
    <ul>
      <li><a href="index.html"><i class="fas fa-home icon"></i><span class="text">Home</span></a></li>
      <li><a href="ai.html"><i class="fas fa-robot icon"></i><span class="text">AI</span></a></li>
      <li><a href="tools.html"><i class="fa-solid fa-screwdriver-wrench"></i><span class="text">Tools</span></a></li>
      <li><a href="games.html"><i class="fas fa-gamepad icon"></i><span class="text">Games</span></a></li>
      <li><a href="music.html"><i class="fas fa-music icon"></i><span class="text">Music</span></a></li>
      <li><a href="chat.html"><i class="fa-regular fa-comments icon"></i><span class="text">Chat</span></a></li>
      <li><a href="settings.html"><i class="fas fa-cog icon"></i><span class="text">Settings</span></a></li>
    </ul>
  </div>

    <header>
        <input type="text" id="musicInput" class="search-box" placeholder="Search music..." onkeypress="if(event.key === 'Enter') fetchMusic('search')">
    </header>

    <section class="hero">
        <h1>Codelistener Music</h1>
        <p>Private encrypted tunnel active. Playing in background enabled.</p>
    </section>

    <div class="row" id="fav-row" style="display: none;">
        <div class="row-title" style="color: var(--mint);">‚ù§ My List</div>
        <div class="track-container" id="favorites-container"></div>
    </div>

    <div class="row">
        <div class="row-title">Global Trending</div>
        <div class="track-container" id="trending-container"></div>
    </div>

    <div class="row" id="search-row" style="display: none;">
        <div class="row-title">Search Results</div>
        <div class="track-container" id="search-container"></div>
    </div>

    <div class="player-bar">
        <div class="now-playing-info">
            <img id="current-art" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEn3YltX7Cs7W7IrAxFTyWw-nmFg03UolfHg&s">
            <div>
                <div id="now-playing-title" style="font-weight: 700; font-size: 14px;">Nothing Playing</div>
                <div id="now-playing-artist" style="font-size: 11px; color: #888;">Select a track</div>
                <span id="status-msg" style="font-size: 10px; color: var(--mint);"></span>
            </div>
            <i class="fa-solid fa-heart" id="fav-btn" onclick="toggleFavorite()"></i>
        </div>
        
        <div class="player-center">
            <div class="controls">
                <button class="control-btn" onclick="togglePlay()"><i class="fa-solid fa-play" id="play-icon"></i></button>
                <button class="control-btn" onclick="togglePiP()" title="Mini Player"><i class="fa-solid fa-up-right-from-square"></i></button>
            </div>
            <div class="progress-wrapper">
                <svg class="squiggly-svg" viewBox="0 0 1000 20" preserveAspectRatio="none">
                    <path id="progress-path" d="M0,10 L1000,10" />
                </svg>
                <input type="range" id="seek-slider" value="0" step="0.1" oninput="manualSeek(this.value)">
            </div>
        </div>
        
        <div style="width: 25%; text-align: right; font-size: 10px; color: #555;">ENCRYPTED TUNNEL v2.5</div>
    </div>

    <audio id="mainAudio"></audio>

<script>
    const PROXY_URL = "https://script.google.com/macros/s/AKfycbx8oqYPseZoVohUBfMTdw-CkxSUsg7KPHoywtwi-ltfg_sweNFJoO_fiyLFIk_02CVsMA/exec";
    const audio = document.getElementById('mainAudio');
    let currentTrackData = null;
    let favorites = JSON.parse(localStorage.getItem('cl-favs')) || [];

    // --- TUNNEL ENGINE ---
    async function getTunneledBlob(url, type) {
        try {
            const res = await fetch(`${PROXY_URL}?type=${type}&url=${encodeURIComponent(url)}`);
            const b64 = await res.text();
            if (!b64 || b64.trim().startsWith("<!DOCTYPE")) return null;
            
            const byteChars = atob(b64.trim());
            const byteNums = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
            const blob = new Blob([new Uint8Array(byteNums)], { type: type === 'image' ? 'image/jpeg' : 'audio/mpeg' });
            return URL.createObjectURL(blob);
        } catch (e) { return null; }
    }

    // --- PIP ENGINE (Null Protected) ---
    function drawPiPFrame() {
        const canvas = document.getElementById('pipCanvas');
        if (!canvas || !currentTrackData) return;
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('current-art');
        
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, 500, 500);
        ctx.globalAlpha = 0.4;
        ctx.drawImage(img, -50, -50, 600, 600);
        ctx.globalAlpha = 1.0;

        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fillRect(0, 380, 500, 120);
        ctx.fillStyle = "#26ff9a";
        ctx.font = "bold 28px Inter";
        ctx.fillText(currentTrackData.title.substring(0, 25), 25, 430);
        ctx.fillStyle = "#fff";
        ctx.font = "20px Inter";
        ctx.fillText(currentTrackData.artist, 25, 470);

        if (!audio.paused) {
            ctx.strokeStyle = "#26ff9a";
            ctx.lineWidth = 4;
            ctx.beginPath();
            for (let i = 0; i < 500; i += 10) {
                const h = Math.sin(Date.now() / 150 + i) * 15;
                ctx.lineTo(i, 380 + h);
            }
            ctx.stroke();
            requestAnimationFrame(drawPiPFrame);
        }
    }

    async function togglePiP() {
        const pipVideo = document.getElementById('pipVideo');
        const pipCanvas = document.getElementById('pipCanvas');
        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
            } else {
                if (!currentTrackData) return alert("Play music first!");
                pipVideo.srcObject = pipCanvas.captureStream();
                drawPiPFrame();
                await pipVideo.play();
                await pipVideo.requestPictureInPicture();
            }
        } catch (e) { console.error("PiP Error:", e); }
    }

    // --- PLAYER CORE ---
    function updateMediaSession() {
        if ('mediaSession' in navigator && currentTrackData) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: currentTrackData.title,
                artist: currentTrackData.artist,
                artwork: [{ src: document.getElementById('current-art').src, sizes: '512x512', type: 'image/jpeg' }]
            });
            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
        }
    }

    async function playTrack(apiUrl, title, artist, img) {
        currentTrackData = { apiUrl, title, artist, img };
        document.getElementById('now-playing-title').innerText = title;
        document.getElementById('now-playing-artist').innerText = artist;
        document.getElementById('status-msg').innerText = "Connecting...";
        updateFavUI();
        
        getTunneledBlob(img, 'image').then(url => { 
            if(url) {
                document.getElementById('current-art').src = url;
                updateMediaSession();
                if (document.pictureInPictureElement) drawPiPFrame();
            }
        });
        
        const blobUrl = await getTunneledBlob(apiUrl, 'stream');
        if (blobUrl) {
            audio.src = blobUrl;
            audio.play();
            document.getElementById('status-msg').innerText = "Live";
        }
    }

    function togglePlay() {
        if (!audio.src) return;
        audio.paused ? audio.play() : audio.pause();
    }

    function toggleFavorite() {
        if (!currentTrackData) return;
        const index = favorites.findIndex(f => f.apiUrl === currentTrackData.apiUrl);
        if (index > -1) favorites.splice(index, 1);
        else favorites.push(currentTrackData);
        localStorage.setItem('cl-favs', JSON.stringify(favorites));
        updateFavUI();
    }

    function updateFavUI() {
        const container = document.getElementById('favorites-container');
        document.getElementById('fav-btn').classList.toggle('active', currentTrackData && favorites.some(f => f.apiUrl === currentTrackData.apiUrl));
        if (favorites.length > 0) {
            document.getElementById('fav-row').style.display = 'block';
            container.innerHTML = "";
            favorites.forEach(track => container.appendChild(createCard(track)));
        } else { document.getElementById('fav-row').style.display = 'none'; }
    }

    function createCard(track) {
        const card = document.createElement('div');
        card.className = 'track-card';
        const imgId = "img-" + Math.random().toString(36).substr(2, 9);
        card.onclick = () => playTrack(track.apiUrl, track.title, track.artist, track.img);
        card.innerHTML = `
            <div style="width:100%; height:100%; background:#111; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-compact-disc fa-spin" style="color:#222; font-size:40px;"></i>
                <img id="${imgId}" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; transition:0.3s; object-fit:cover;">
            </div>
            <div class="track-overlay">
                <div class="track-title">${track.title}</div>
                <div class="track-artist">${track.artist}</div>
            </div>`;
        getTunneledBlob(track.img, 'image').then(blobUrl => {
            const el = document.getElementById(imgId);
            if (el && blobUrl) { el.src = blobUrl; el.style.opacity = 1; el.previousElementSibling.style.display = 'none'; }
        });
        return card;
    }

    async function fetchMusic(mode) {
        const query = document.getElementById('musicInput').value || 'phonk';
        const sRow = document.getElementById('search-row');
        const sContainer = document.getElementById('search-container');
        const tContainer = document.getElementById('trending-container');
        
        if(mode === 'search') { 
            sRow.style.display = 'block'; 
            sContainer.innerHTML = "<p style='padding-left:20px;'>Loading...</p>";
            sRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        try {
            const res = await fetch(`${PROXY_URL}?type=${mode}&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            const tracks = data.collection ? data.collection.map(i => i.track || i) : (data.tracks || []);
            const target = mode === 'search' ? sContainer : tContainer;
            target.innerHTML = "";
            tracks.forEach(t => {
                const prog = t.media?.transcodings.find(tr => tr.format.protocol === 'progressive');
                if (!prog) return;
                const img = t.artwork_url ? t.artwork_url.replace('-large', '-t500x500') : 'https://i1.sndcdn.com/avatars-000433604313-uuzpva-t500x500.jpg';
                target.appendChild(createCard({apiUrl: prog.url, title: t.title, artist: t.user.username, img}));
            });
        } catch (err) { console.error(err); }
    }

    function manualSeek(val) { if (audio.duration) audio.currentTime = (val / 100) * audio.duration; }
    audio.onplay = () => { document.getElementById('progress-path').classList.add('animate-wiggle'); document.getElementById('play-icon').className = "fa-solid fa-pause"; drawPiPFrame(); };
    audio.onpause = () => { document.getElementById('progress-path').classList.remove('animate-wiggle'); document.getElementById('play-icon').className = "fa-solid fa-play"; };
    audio.ontimeupdate = () => {
        const pct = (audio.currentTime / audio.duration) * 100;
        document.getElementById('seek-slider').value = pct || 0;
        document.getElementById('progress-path').style.strokeDasharray = `${pct * 10}, 1000`;
    };

    window.onload = () => { fetchMusic('trending'); updateFavUI(); };
</script>
</body>
</html>